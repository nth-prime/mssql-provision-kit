#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="/opt/mssql-provision-kit"
SECTOR_DIR="$BASE_DIR/sectors"
CONFIG_FILE="/etc/mssql-provision-kit/provision.conf"
VERSION_FILE="$BASE_DIR/VERSION"

current_version() {
  if [[ -f "$VERSION_FILE" ]]; then
    tr -d '[:space:]' < "$VERSION_FILE"
  else
    echo "unknown"
  fi
}

run_sector() {
  local script="$1"
  shift || true
  if [[ ! -x "$script" ]]; then
    echo "Missing sector: $script"
    return 1
  fi
  if [[ $(id -u) -ne 0 ]]; then
    sudo "$script" "$@"
  else
    "$script" "$@"
  fi
}

run_sector_safe() {
  if ! run_sector "$@"; then
    echo "Action failed: $1"
    return 0
  fi
}

pick_editor() {
  if [[ -n "${EDITOR:-}" ]]; then
    echo "$EDITOR"; return 0
  fi
  command -v nano >/dev/null 2>&1 && { echo nano; return 0; }
  command -v vi >/dev/null 2>&1 && { echo vi; return 0; }
  return 1
}

edit_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Config missing: $CONFIG_FILE"
    return 1
  fi
  local ed
  ed="$(pick_editor)" || { echo "No editor found."; return 1; }
  if [[ $(id -u) -ne 0 ]]; then
    sudo "$ed" "$CONFIG_FILE"
  else
    "$ed" "$CONFIG_FILE"
  fi
}

storage_menu() {
  while true; do
    clear || true
    echo "=============================="
    echo " Storage Layout"
    echo "=============================="
    echo "1) Run Storage Preflight"
    echo "2) Inspect Storage and Filesystems"
    echo "3) Run Storage Health Checks"
    echo "4) Preview SQL Directory Layout (Dry-Run)"
    echo "5) Apply SQL Directory Layout"
    echo "6) Validate SQL Directory Layout"
    echo "7) Export Storage Report"
    echo "8) Back"
    read -rp "Select: " sopt
    case "$sopt" in
      1) run_sector_safe "$SECTOR_DIR/40-storage-preflight.sh" ;;
      2) run_sector_safe "$SECTOR_DIR/41-storage-inspect.sh" ;;
      3) run_sector_safe "$SECTOR_DIR/42-storage-health.sh" ;;
      4) run_sector_safe "$SECTOR_DIR/43-storage-layout.sh" --dry-run ;;
      5) run_sector_safe "$SECTOR_DIR/43-storage-layout.sh" --apply ;;
      6) run_sector_safe "$SECTOR_DIR/44-storage-validate.sh" ;;
      7) run_sector_safe "$SECTOR_DIR/47-storage-report.sh" ;;
      8) return 0 ;;
      *) echo "Invalid option" ;;
    esac
    if ! read -rp "Run another storage action? (Y/n): " again; then
      return 0
    fi
    [[ -z "$again" || "$again" =~ ^[yY]$ ]] || return 0
  done
}

while true; do
  clear || true
  VERSION="$(current_version)"
  echo "=============================="
  echo " MSSQL Provision Kit v$VERSION"
  echo "=============================="
  echo "1) Edit Config"
  echo "2) Run Host + SQL Preflight"
  echo "3) Dry-Run Install Plan"
  echo "4) Install SQL Server 2025"
  echo "5) Post-Install Validation"
  echo "6) Storage Layout"
  echo "7) Uninstall / Cleanup"
  echo "8) Show State + Logs"
  echo "9) Run Unit Tests"
  echo "10) Restart Machine Now"
  echo "11) Update Provision Kit from GitHub"
  echo "12) Run Network Validation"
  echo "13) Configure Network Policy"
  echo "14) Print Effective Config"
  echo "q) Quit"
  read -rp "Select: " opt

  case "$opt" in
    1) edit_config ;;
    2) run_sector_safe "$SECTOR_DIR/10-host-preflight.sh" ;;
    3) run_sector_safe "$SECTOR_DIR/20-install-sql.sh" --dry-run ;;
    4) run_sector_safe "$SECTOR_DIR/20-install-sql.sh" --apply ;;
    5) run_sector_safe "$SECTOR_DIR/30-post-validate.sh" ;;
    6) storage_menu ;;
    7) run_sector_safe "$SECTOR_DIR/80-uninstall-cleanup.sh" ;;
    8) run_sector_safe "$SECTOR_DIR/90-show-state.sh" ;;
    9) run_sector_safe "$SECTOR_DIR/50-run-unit-tests.sh" ;;
    10) run_sector_safe "$SECTOR_DIR/85-restart-now.sh" ;;
    11) run_sector_safe "$SECTOR_DIR/05-update-kit.sh" ;;
    12) run_sector_safe "$SECTOR_DIR/31-network-validate.sh" ;;
    13) run_sector_safe "$SECTOR_DIR/32-network-apply.sh" ;;
    14) run_sector_safe "$SECTOR_DIR/92-print-effective-config.sh" ;;
    q|Q) exit 0 ;;
    *) echo "Invalid selection." ;;
  esac

  if ! read -rp "Run another selector? (Y/n): " again; then
    exit 0
  fi
  [[ -z "$again" || "$again" =~ ^[yY]$ ]] || exit 0
done
