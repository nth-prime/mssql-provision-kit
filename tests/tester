#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
UNIT_DIR="$ROOT_DIR/tests/unit"

pass=0
fail=0

run_test() {
  local t="$1"
  echo "==> $t"
  if bash "$t"; then
    echo "PASS: $t"
    pass=$((pass+1))
  else
    echo "FAIL: $t"
    fail=$((fail+1))
  fi
  echo
}

echo "Running mssql-provision-kit tests"

if command -v bash >/dev/null 2>&1; then
  echo "Syntax check: install.sh provision lib/lib.sh sectors/*.sh tests/unit/*.sh"
  bash -n "$ROOT_DIR/install.sh"
  bash -n "$ROOT_DIR/provision"
  bash -n "$ROOT_DIR/lib/lib.sh"
  for f in "$ROOT_DIR"/sectors/*.sh "$UNIT_DIR"/*.sh; do
    bash -n "$f"
  done
else
  echo "bash not found; cannot run test harness"
  exit 1
fi

for t in "$UNIT_DIR"/*.sh; do
  run_test "$t"
done

echo "Summary: pass=$pass fail=$fail"
[[ $fail -eq 0 ]]